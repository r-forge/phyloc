\documentclass{article}
%\VignetteIndexEntry{phylo4 design}
%\VignettePackage{phylo4}
%\VignetteDepends{ape}
\usepackage[utf8]{inputenc} % for UTF-8/single quotes from sQuote()
\newcommand{\code}[1]{{{\tt #1}}}
\title{Design decisions for the phylo4 class}
\author{Ben Bolker}
\date{\today}
\usepackage{/usr/share/R/share/texmf/Sweave}
\begin{document}
\maketitle

This document describes the design decisions associated
with the new ``phylo4'' class, which is intended to
provide some kind of unifying standard for phylogenetic
data in R.  It is closely modeled on the the \code{phylo}
class in \code{ape}, which is the dominant data structure
at the moment.

Like \code{phylo}, the main components of
the \code{phylo4} class are:
\begin{description}
\item[edge]{an $N \times 2$ matrix of integers,
  where the first column \ldots}
\item[edge.length]{numeric list of edge lengths
(length $N$ or empty)}
\item[Nnode]{integer, number of nodes}
\item[tip.label]{character vector of tip labels (required)}
\item[node.label]{character vector of node labels (maybe empty)}
\item[root.edge]{integer defining root edge (maybe NA)}
\end{description}

Print method: add information about
(ultrametric, scaled, polytomies (zero-length or structural))?
 
\section{Hacks/backward compatibility}

Hilmar Lapp very kindly showed a way to hack
the \verb+$+ operator so that it would provide
backward compatibility with code that is 
extracting internal elements of a \code{phylo4}.
The basic recipe is:
\begin{Schunk}
\begin{Sinput}
> setMethod("$", "phylo4", function(x, name) {
+     attr(x, name)
+ })
\end{Sinput}
\end{Schunk}
but this has to be hacked slightly to intercept
calls to elements that might be missing.  For example,
\code{ape} detects whether log-likelihood, root edges,
node labels, etc. are missing by testing whether they
are \code{NULL}, whereas missing items are represented
in \code{phylo4} by zero-length vectors in the slots 
(or \code{NA} for the root edge) --- so we need code
like
\begin{Schunk}
\begin{Sinput}
> if (!hasNodeLabels(x)) NULL else x@node.label
\end{Sinput}
\end{Schunk}
to handle these cases.

\begin{Schunk}
\begin{Sinput}
> library(ape)
\end{Sinput}
\end{Schunk}
\section{To do/problems}


\begin{itemize}
\item Conflict with \code{nTips} if \code{ape} is loaded first:
ask EP to get rid of this (obsolete?) function? (\code{Ntips}
is the real \code{ape} function for getting the number of tips)
\item basic tree manipulation: tip-dropping, \code{na.omit}, etc. --- 
especially for multi-tree and tree-with-data cases
\item tree-manipulation code: tree traversal (store current
position as an attribute), pruning, etc.
\end{itemize}

\end{document}
